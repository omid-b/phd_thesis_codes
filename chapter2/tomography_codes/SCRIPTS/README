This README is written by Omid Bagherpur (omid.bagherpur@gmail.com)

In order facilitate Sergei's tomography procedure and avoid probable mistakes, 
I developed a new set of scripts. In this new procedure, the only file that needs to be modified
is "param.csh". This file is loaded in all other c-shell scripts (not python ones),
so there would be no need to apply any modification to the other scripts in this directory.

Note: one can run the scripts to see the usage message.

#=====GENERAL PROCEDURE FOR INVERSION WORK=====#

1) Gather dataset together in a directory (*.disp format); make sure all codes are compiled 
in "$softwaredir/BIN" directory.

2) Set all the parameters in "param.csh"; parameter information is available at the end of "param.csh".

3) Use script "init.csh" to initialize a runset directory. This script makes sure 
all parameters in "param.csh" are set correctly and then creates the runset direcotry 
with essential inputs (datalist, inbac, iniac, inxc). Further scripts read their inputs
from the input files generated by this script in the runset directory. Therefore, one can even
modify the generated essential inputs before running the further scripts

4) Use script "run_inv.csh" to run the inversions and reformatting processes 
for the created runset. This script actually automates running "bac", "iac", and "xsc" codes. 
Next, check the generated "outbac", "outiac", and "outxc" files in $runsetdir/inv 
directory to make sure that everything is working.

5) Use script "plot_runset.gmt" to generate plots of the inversion results.
This script takes a runset as the input and uses data in "$runsetdir/inv*" to generate plots.
Plots will be saved as pdf files in "$runsetdir/plt_inv*" directories.
In this step,  I recommend trying for a less number of periods first (Usage2);
when made sure the generated plots are looking fine, then generate the plots for all periods (Usage1).

6) Carry out the following outlier exclusion procedure to make sure there are no spurious paths
that are impossible for the inversion scheme to fit (as these paths may have data issues, and
would thus bias the variance-reduction statistics etc.):

  (i) Repeat steps 2-5 with a different setting:
  Set VERY low values of smoothing and damping parameters in "param.csh", 
  use script "init.csh" to initialize a new runset, and run inversion processes
  using script "run_inv.csh" to produce a rough model that therefore fits the data
  as well as possible.
    
  (ii) Use script "outliers.csh" to carry out outlier exclusion procedure.
  This script automates usage of program "excl_outl" allowing one to exclude
  outlier measurements at each period. Note that one should adjust "outliers_setting"
  parameter in "param.csh" for desired purpose. This script takes two inputs:
  The main inputs to this scripts are the two previously processed runsets, 
  the non-regularized (rough model), and regularized runsets. 
  Feel free to repeat running this script after changing the "outliers_setting" in "param.csh".
  
  This script, "outliers.csh", outputs a directory (a) and a file (b) in the regularized
  runset directory:
  
    (a) "$runsetdir/outlier_info": This directory contains the results of the inversions for
    the rough model (non-regularized runset) to be used in the script for outlier exclusion process
    based on threshold criteria. Folder names in this directory are in "XXX_orig"  
    format where XXX is the period. In each period directory:
      -- rhs1 (line number; original rhs; rhs scaled to km/s; curve-file name), 
      -- syndat (line #; synthetic rhs in km/s; curve-file name), 
      -- syndif (line #; data-synthetic rhs mismatch in km/s; data-synthetic 
         rhs mismatch as proportion of measurement error; curve-file name),
      -- path_sel (the list with selected, non-outlier measurements,  
         to be used for a re-run of bac.f), 
      -- path_nsl (the list with rejected, outlier measurements), 
      -- paths_sel.xy and paths_bad.xy for GMT plotting.
      
    (b) "$runsetdir/inbac_outl": This is the "inbac" file used to run the inversions with 
    the outlier exclusion process applied; input to the "excl_outl" code.

    
7) Use script "run_inv_outl.csh" to run the inversions and reformatting processes 
using the previously created "inbac_outl". This script is very similar to script "run_inv.csh" 
except that it uses "inbac_outl" instead of "inbac" when running the inversions. 
New inversion results will be in "inv_outl" directory. Generate plots for the new results,
check the inversion stats and make sure the outlier exclusion process has improved the results.

8) Use script "damp_test.py" to run inversions using different damping parameters (fixed smoothing parameters)

9) Use script "smth_test.py" to run inversions using different smoothing parameters (fixed damping parameters)

10) Investigate trade-off curves generated by the previous steps (steps 8 and 9) and decide about the right
damping and smoothing parameters

11) Adjustment of reference velocities; when the inversion is run, the initial reference velocity
is the average of all the phase velocities across the region for a given period. In theory this
should balance the phase velocity maps such that the average value of the phase velocity is 0.0
In practice, this is rarely the case, so some adjustment is necessary to get a proper balance.
When the code "bac" is run with the value 0 in the 2nd column of the "inbac" file, the data average is taken
as the reference velocity, and this value can be found in the last column of the text file
"matrix_key".
  To make the adjustments:
  i) for each period, copy the reference velocity from "matrix_key" to the 2nd column of "inbac_outl".
  Do a complete run of bac/iac/xsc (script 'run_inv_outl.csh') and note the average value of the 
  isotropic phase velocity. If it is not zero, adjust the reference velocity in "inbac" and repeat. 
  Continue doing this for all the different periods until the average isotropic phase velocity is zero.
  
  
